name: Docker Deploy to EC2

on:
  push:
    branches:
      - master  # Change to 'main' if your branch is named main
  workflow_dispatch: # Allows you to click a button to redeploy manually

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_ELASTIC_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            PROJECT_DIR="/home/ubuntu/utrack-backend"
            cd "$PROJECT_DIR"
            
            # 1. Pull latest code
            git fetch origin master
            git reset --hard origin/master
            
            # 2. Overwrite .env with ALL current secrets
            # This ensures any changes in GitHub Secrets are applied immediately
            # Using printf to safely handle special characters
            {
              printf 'SECRET_KEY=%s\n' "${{ secrets.DJANGO_SECRET_KEY }}"
              printf 'POSTGRES_DB=%s\n' "${{ secrets.POSTGRES_DB }}"
              printf 'POSTGRES_USER=%s\n' "${{ secrets.POSTGRES_USER }}"
              printf 'POSTGRES_PASSWORD=%s\n' "${{ secrets.POSTGRES_PASSWORD }}"
              printf 'DATABASE_URL=postgres://%s:%s@db:5432/%s\n' "${{ secrets.POSTGRES_USER }}" "${{ secrets.POSTGRES_PASSWORD }}" "${{ secrets.POSTGRES_DB }}"
              printf 'ALLOWED_HOSTS=%s\n' "${{ secrets.ALLOWED_HOSTS }}"
              printf '\n'
              printf '# Apple / iCloud Secrets\n'
              printf 'APPLE_KEY_ID=%s\n' "${{ secrets.APPLE_KEY_ID }}"
              printf 'APPLE_TEAM_ID=%s\n' "${{ secrets.APPLE_TEAM_ID }}"
              printf 'APPLE_CLIENT_ID=%s\n' "${{ secrets.APPLE_CLIENT_ID }}"
              printf 'APPLE_PRIVATE_KEY=%s\n' "${{ secrets.APPLE_PRIVATE_KEY }}"
              printf '\n'
              printf '# Infrastructure & Environment\n'
              printf 'EC2_ELASTIC_IP=%s\n' "${{ secrets.EC2_ELASTIC_IP }}"
              printf 'API_HOST=%s\n' "${{ secrets.API_HOST }}"
              printf 'LOCALHOST=False\n'
            } > .env

            # 3. Build the new image and restart the containers
            # Docker Compose is smart: it only restarts what has changed
            
            # We make this commented out because postgre is set optinal and wont start if not requested, to allow local development with sqlite
            # docker compose up -d --build
            docker compose --profile postgres up -d --build            

            
            # 4. Clean up old images to keep EC2 disk space free
            docker image prune -f
            
            echo "Deployment successful"