name: Deploy to EC2

on:
  push:
    branches:
      - master
  workflow_dispatch:  # Allows manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # 1. Set variables
          PROJECT_DIR="/home/ubuntu/utrack-backend"
          REPO_URL="https://github.com/emreutkan/utrack-be"
          
          # 2. Install system dependencies
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y python3.12 python3.12-venv python3-pip postgresql postgresql-contrib git libpq-dev python3-dev
          
          # 3. Clone or update repository
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "Cloning repository..."
            sudo mkdir -p "$PROJECT_DIR"
            sudo chown ubuntu:ubuntu "$PROJECT_DIR"
            git clone "$REPO_URL" "$PROJECT_DIR"
          else
            echo "Updating repository..."
            cd "$PROJECT_DIR"
            git pull origin master
          fi

          cd "$PROJECT_DIR"
          
          # 4. Create venv if it doesn't exist
          if [ ! -d "$PROJECT_DIR/venv" ]; then
            echo "Creating virtual environment..."
            python3.12 -m venv "$PROJECT_DIR/venv"
          fi
          
          # 5. Extract Secrets
          DB_NAME="${{ secrets.DB_NAME }}"
          DB_USER="${{ secrets.DB_USER }}"
          DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          SECRET_KEY="${{ secrets.DJANGO_SECRET_KEY }}"
          ALLOWED_HOSTS="${{ secrets.ALLOWED_HOSTS }}"
          DB_HOST="localhost"
          DB_PORT="5432"
          
          # Validation
          if [ -z "$DB_PASSWORD" ] || [ -z "$SECRET_KEY" ]; then
            echo "ERROR: Required secrets (DB_PASSWORD or DJANGO_SECRET_KEY) are missing."
            exit 1
          fi
          
          # Set defaults
          DB_NAME="${DB_NAME:-utrack_db}"
          DB_USER="${DB_USER:-utrack_user}"
          ALLOWED_HOSTS="${ALLOWED_HOSTS:-*}"
          
          # 6. Activate venv and install dependencies
          source "$PROJECT_DIR/venv/bin/activate"
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install gunicorn psycopg2-binary
          
          # 7. Check and create database
          # IMPORTANT: The EOF below MUST be at the very start of the line.
          if ! sudo -u postgres psql -lqt | cut -d \| -f 1 | grep -qw "$DB_NAME"; then
          echo "Setting up PostgreSQL database..."
          sudo -u postgres psql <<EOF
          CREATE DATABASE $DB_NAME;
          CREATE USER $DB_USER WITH PASSWORD '$DB_PASSWORD';
          ALTER ROLE $DB_USER SET client_encoding TO 'utf8';
          ALTER ROLE $DB_USER SET default_transaction_isolation TO 'read committed';
          ALTER ROLE $DB_USER SET timezone TO 'UTC';
          GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;
          \q
          EOF
            echo "PostgreSQL database created!"
          else
            echo "PostgreSQL database already exists!"
          fi
          
          # 8. Run migrations
          export SECRET_KEY DEBUG="False" DB_NAME DB_USER DB_PASSWORD DB_HOST DB_PORT ALLOWED_HOSTS
          python3 manage.py migrate
          mkdir -p "$PROJECT_DIR/logs"
          
          # 9. Setup systemd service for Gunicorn
          # IMPORTANT: The EOF below MUST be at the very start of the line.
          sudo tee /etc/systemd/system/utrack.service > /dev/null <<EOF
          [Unit]
          Description=UTrack Django application
          After=network.target

          [Service]
          User=ubuntu
          Group=www-data
          WorkingDirectory=$PROJECT_DIR
          Environment="PATH=$PROJECT_DIR/venv/bin"
          Environment="SECRET_KEY=$SECRET_KEY"
          Environment="DEBUG=False"
          Environment="DB_NAME=$DB_NAME"
          Environment="DB_USER=$DB_USER"
          Environment="DB_PASSWORD=$DB_PASSWORD"
          Environment="DB_HOST=$DB_HOST"
          Environment="DB_PORT=$DB_PORT"
          Environment="ALLOWED_HOSTS=$ALLOWED_HOSTS"
          ExecStart=$PROJECT_DIR/venv/bin/gunicorn \
              --workers 3 \
              --bind unix:$PROJECT_DIR/utrack.sock \
              --timeout 120 \
              utrack.wsgi:application

          [Install]
          WantedBy=multi-user.target
          EOF
          
          # 10. Start service
          sudo systemctl daemon-reload
          sudo systemctl enable utrack
          sudo systemctl restart utrack

          echo "Deployment completed successfully!"