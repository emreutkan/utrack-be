name: Deploy to EC2

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e
          PROJECT_DIR="/home/ubuntu/utrack-backend"
          SERVICE_FILE="/etc/systemd/system/utrack.service"
          cd "$PROJECT_DIR"
          
          # 1. Force pull latest code (Fixing divergent branches)
          git fetch origin master
          git reset --hard origin/master
          
          # 2. Update .env file (Removed extra quotes for better systemd compatibility)
          echo "SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}" > .env
          echo "DB_NAME=${{ secrets.DB_NAME }}" >> .env
          echo "DB_USER=${{ secrets.DB_USER }}" >> .env
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
          echo "DB_HOST=localhost" >> .env
          echo "DB_PORT=5432" >> .env
          echo "DEBUG=False" >> .env
          echo "ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}" >> .env

          # 3. RE-CONFIGURING THE SERVICE (Kill the hardcoded values)
          # This ensures the service reads the .env file instead of hardcoded strings
          sudo bash -c "cat > $SERVICE_FILE <<EOF
          [Unit]
          Description=UTrack Django application
          After=network.target

          [Service]
          User=ubuntu
          Group=www-data
          WorkingDirectory=$PROJECT_DIR
          EnvironmentFile=$PROJECT_DIR/.env
          ExecStart=$PROJECT_DIR/venv/bin/gunicorn --workers 3 --bind unix:$PROJECT_DIR/utrack.sock --timeout 120 utrack.wsgi:application
          Restart=always

          [Install]
          WantedBy=multi-user.target
          EOF"

          # 4. Reload Systemd to recognize the service change
          sudo systemctl daemon-reload

          # 5. DB Permissions Fix
          sudo -u postgres psql -d ${{ secrets.DB_NAME }} -c "GRANT ALL ON SCHEMA public TO ${{ secrets.DB_USER }};" || true
          sudo -u postgres psql -d ${{ secrets.DB_NAME }} -c "ALTER SCHEMA public OWNER TO ${{ secrets.DB_USER }};" || true

          # 6. Update Dependencies
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # 7. Django Tasks
          export \$(grep -v '^#' .env | xargs)
          python3 manage.py migrate --noinput
          python3 manage.py collectstatic --noinput
          
          # 8. Restart everything
          sudo systemctl restart utrack
          sudo systemctl restart nginx
          
          echo "âœ… Deployment successful. Infrastructure sync complete."
