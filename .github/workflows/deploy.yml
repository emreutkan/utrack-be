name: Deploy to EC2

on:
  push:
    branches:
      - master
  workflow_dispatch:  # Allows manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # 1. Set variables
          PROJECT_DIR="/home/ubuntu/utrack-backend"
          REPO_URL="https://github.com/emreutkan/utrack-be"
          
          # 2. Install system dependencies (Adding nginx here)
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y python3.12 python3.12-venv python3-pip postgresql postgresql-contrib git libpq-dev python3-dev nginx
          
          # 3. Clone or update repository
          if [ ! -d "$PROJECT_DIR" ]; then
            sudo mkdir -p "$PROJECT_DIR"
            sudo chown ubuntu:ubuntu "$PROJECT_DIR"
            git clone "$REPO_URL" "$PROJECT_DIR"
          else
            cd "$PROJECT_DIR"
            git pull origin master
          fi

          cd "$PROJECT_DIR"
          
          # 4. Create venv and install dependencies
          if [ ! -d "venv" ]; then
            python3.12 -m venv venv
          fi
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt gunicorn psycopg2-binary
          
          # 5. Extract Secrets & Environment Setup
          export SECRET_KEY="${{ secrets.DJANGO_SECRET_KEY }}"
          export DB_NAME="${{ secrets.DB_NAME }}"
          export DB_USER="${{ secrets.DB_USER }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export ALLOWED_HOSTS="${{ secrets.ALLOWED_HOSTS }}"
          export DB_HOST="localhost"
          export DB_PORT="5432"
          export DEBUG="False"
          
          # 6. Database Setup
          if ! sudo -u postgres psql -lqt | cut -d \| -f 1 | grep -qw "$DB_NAME"; then
            sudo -u postgres psql <<EOF
          CREATE DATABASE $DB_NAME;
          CREATE USER $DB_USER WITH PASSWORD '$DB_PASSWORD';
          GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;
          EOF
          fi
          
          # 7. Django Prep (Migrations + Static Files)
          python3 manage.py migrate --noinput
          python3 manage.py collectstatic --noinput
          
          # 8. Setup Gunicorn Systemd Service
          sudo tee /etc/systemd/system/utrack.service > /dev/null <<EOF
          [Unit]
          Description=UTrack Django application
          After=network.target

          [Service]
          User=ubuntu
          Group=www-data
          WorkingDirectory=$PROJECT_DIR
          Environment="PATH=$PROJECT_DIR/venv/bin"
          Environment="SECRET_KEY=$SECRET_KEY"
          Environment="DB_NAME=$DB_NAME"
          Environment="DB_USER=$DB_USER"
          Environment="DB_PASSWORD=$DB_PASSWORD"
          Environment="DB_HOST=$DB_HOST"
          Environment="DB_PORT=$DB_PORT"
          Environment="ALLOWED_HOSTS=$ALLOWED_HOSTS"
          Environment="DEBUG=False"
          ExecStart=$PROJECT_DIR/venv/bin/gunicorn --workers 3 --bind unix:$PROJECT_DIR/utrack.sock utrack.wsgi:application

          [Install]
          WantedBy=multi-user.target
          EOF
          
          # 9. Setup Nginx Configuration
          sudo tee /etc/nginx/sites-available/utrack > /dev/null <<EOF
          server {
              listen 80;
              server_name ${{ secrets.EC2_HOST }};

              location = /favicon.ico { access_log off; log_not_found off; }

              location /static/ {
                  root $PROJECT_DIR;
              }

              location / {
                  include proxy_params;
                  proxy_pass http://unix:$PROJECT_DIR/utrack.sock;
              }
          }
          EOF

          # 10. Permissions & Activation
          sudo chmod 755 /home/ubuntu
          sudo chmod 755 $PROJECT_DIR
          
          sudo ln -sf /etc/nginx/sites-available/utrack /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default  # Remove default nginx page if it exists
          
          # 11. Final Services Restart
          sudo systemctl daemon-reload
          sudo systemctl restart utrack
          sudo systemctl enable utrack
          
          if sudo nginx -t; then
              sudo systemctl restart nginx
          else
              echo "Nginx configuration error!"
              exit 1
          fi

          echo "Deployment of UTrack successful!"